<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Maggie Bakery | Reservations</title>

  <style>
    :root{
      --gold:#c9a86a;
      --gold2:#b89655;
      --green:#0f3d2e;
      --text:#16221c;
      --muted:#5c6b63;
      --card: rgba(255,255,255,.92);
      --stroke: rgba(201,168,106,.22);
      --shadow: 0 60px 140px rgba(0,0,0,.35);
      --shadow2: 0 28px 90px rgba(0,0,0,.22);
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      min-height:100vh;
      background: linear-gradient(rgba(13,55,40,.76), rgba(13,55,40,.90));
      color: var(--text);
      overflow-x:hidden;
    }

    /* Background image */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      background:url("images/restaurant.jpg") center/cover no-repeat;
      filter: blur(4px) brightness(.92);
      transform: scale(1.04);
      z-index:-2;
    }
    body::after{
      content:"";
      position:fixed;
      inset:0;
      background: linear-gradient(rgba(13,55,40,.22), rgba(13,55,40,.48));
      z-index:-1;
    }

    .wrap{
      max-width: 980px;
      margin: 44px auto;
      padding: 0 16px 64px;
    }

    .card{
      background: var(--card);
      backdrop-filter: blur(18px);
      border-radius: 28px;
      padding: 30px;
      box-shadow: var(--shadow);
      border: 1px solid var(--stroke);
    }

    /* Top brand */
    .brand{
      font-size: 28px;
      letter-spacing: .26em;
      text-transform: uppercase;
      color: var(--gold);
      font-weight: 900;
      text-align:center;
      margin: 6px 0 8px;
    }
    .location{
      text-align:center;
      font-size:14px;
      letter-spacing:.18em;
      text-transform:uppercase;
      color: rgba(15,61,46,.65);
      margin: 0 0 12px;
      font-weight: 800;
    }
    .sub{
      margin:0;
      text-align:center;
      color: var(--muted);
      font-size: 14px;
      line-height:1.5;
    }

    /* “menu-like” pills */
    .info{
      margin-top: 18px;
      display:grid;
      gap:10px;
      justify-content:center;
    }
    .pill{
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap: 12px;
      padding: 12px 14px;
      border-radius: 999px;
      background: rgba(15,61,46,.065);
      border: 1px solid rgba(15,61,46,.10);
      color: rgba(15,61,46,.86);
      font-size: 12px;
      font-weight: 750;
      width: min(560px, 100%);
      margin: 0 auto;
    }
    .pill.has-call{ justify-content: space-between; }
    .pill.gold{
      background: rgba(255,255,255,.45);
      border: 1px solid rgba(201,168,106,.55);
      color: rgba(120,86,30,.92);
    }
    .pill a{
      color: rgba(15,61,46,.86);
      text-decoration:none;
      border-bottom: 1px solid rgba(15,61,46,.18);
    }
    .call{
      text-decoration:none;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(201,168,106,.45);
      background: rgba(201,168,106,.16);
      color: rgba(120,86,30,.96);
      font-weight: 900;
      font-size: 12px;
      white-space:nowrap;
    }

    /* View switch */
    .view{ display:none; }
    .view.active{ display:block; }

    .top-actions{
      display:flex;
      justify-content:flex-start;
      gap:10px;
      margin: 18px 0 4px;
    }
    .back{
      appearance:none;
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
      color:#1f2d26;
      padding:10px 12px;
      border-radius:14px;
      font-weight:800;
      cursor:pointer;
    }

    /* Landing cards */
    .landing-grid{
      margin-top: 22px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:16px;
    }

    .tile{
      border-radius: 22px;
      overflow:hidden;
      border:1px solid rgba(0,0,0,.06);
      background: rgba(255,255,255,.86);
      box-shadow: var(--shadow2);
      display:flex;
      flex-direction:column;
      min-height: 420px;
    }

    .hero{
      width:100%;
      aspect-ratio: 16/10;
      background:#ddd 50% 60%/cover no-repeat;
    }

    .tile-body{
      padding: 18px 18px 18px;
      display:flex;
      flex-direction:column;
      gap:10px;
      flex:1;
    }

    .kicker{
      font-size:12px;
      letter-spacing:.18em;
      text-transform:uppercase;
      color: rgba(15,61,46,.70);
      font-weight:900;
    }

    .tile-title{
      margin:0;
      font-size:22px;
      letter-spacing:.02em;
      color: var(--green);
      font-weight: 950;
    }

    .tile-text{
      margin:0;
      color: var(--muted);
      font-size: 14px;
      line-height:1.5;
    }

    .tile-actions{
      margin-top:auto;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    .btn{
      appearance:none;
      border:0;
      border-radius: 16px;
      padding: 12px 16px;
      font-weight: 950;
      letter-spacing:.08em;
      text-transform:uppercase;
      cursor:pointer;
      transition:.15s;
      font-size: 13px;
    }
    .btn.primary{
      background: linear-gradient(135deg, var(--gold), var(--gold2));
      color:#fff;
    }
    .btn.ghost{
      background: rgba(255,255,255,.65);
      border:1px solid rgba(201,168,106,.50);
      color: rgba(120,86,30,.92);
    }
    .btn.disabled{
      background: rgba(0,0,0,.06);
      color: rgba(0,0,0,.35);
      cursor:not-allowed;
      border:1px solid rgba(0,0,0,.06);
    }

    /* DIY form */
    form{ margin-top: 14px; }
    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:14px;
      margin-top: 10px;
    }
    label{
      display:block;
      font-size:13px;
      margin:12px 0 6px;
      color: rgba(15,61,46,.88);
      font-weight: 800;
    }
    input,select,textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(0,0,0,.08);
      background:#fff;
      font-size: 15px;
      outline:none;
    }
    textarea{ min-height: 96px; resize: vertical; }

    .submit{
      margin-top: 18px;
      width:100%;
      border:0;
      border-radius: 18px;
      padding: 15px;
      font-size: 16px;
      font-weight: 950;
      letter-spacing: .10em;
      text-transform: uppercase;
      background: linear-gradient(135deg, var(--gold), var(--gold2));
      color:#fff;
      cursor:pointer;
      transition:.15s;
    }
    .submit:disabled{ opacity:.6; cursor:not-allowed; }

    .toast{
      margin-top: 12px;
      padding: 12px;
      border-radius: 14px;
      font-size: 14px;
      display:none;
    }
    .ok{ background:#e7f7ee; color:#1c6f48; }
    .bad{ background:#ffecec; color:#8b1a1a; }

    /* Time buttons */
    .time-grid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
      margin-top: 8px;
    }
    .time-btn{
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
      padding:10px;
      border-radius:14px;
      font-size:14px;
      font-weight:900;
      cursor:pointer;
      transition:.12s;
      text-align:center;
    }
    .time-btn.selected{
      border-color: rgba(201,168,106,.85);
      box-shadow: 0 0 0 4px rgba(201,168,106,.18);
    }
    .time-btn.disabled{
      opacity:.45;
      cursor:not-allowed;
    }

    /* Flavours */
    .flavour-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    .flavour-item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(0,0,0,.08);
      background:#fff;
    }
    .flavour-name{
      font-weight:950;
      color: rgba(15,61,46,.92);
      font-size:14px;
    }
    .stepper{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .qty{
      width:26px;
      text-align:center;
      font-weight:950;
      font-size:14px;
      color:#1f2d26;
    }
    .step-btn{
      width:34px;
      height:34px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
      cursor:pointer;
      display:grid;
      place-items:center;
      padding:0;
      transition:.12s;
    }
    .step-btn:active{ transform: scale(.98); }
    .step-btn[disabled]{ opacity:.45; cursor:not-allowed; }
    .tri{
      width:0;height:0;
      border-left:6px solid transparent;
      border-right:6px solid transparent;
    }
    .tri.up{ border-bottom:9px solid rgba(15,61,46,.80); }
    .tri.down{ border-top:9px solid rgba(15,61,46,.80); }

    .flavour-hint{
      margin-top:8px;
      font-size:12px;
      color: rgba(15,61,46,.55);
    }

    /* ===== Date Picker (custom, fixes mobile overflow + grey disabled) ===== */
    .date-trigger{
      width:100%;
      border-radius: 16px;
      border: 1px solid rgba(0,0,0,.08);
      background:#fff;
      padding: 12px 12px;
      font-size: 15px;
      font-weight: 850;
      color:#1f2d26;
      cursor:pointer;
      text-align:left;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .date-trigger .muted{
      font-weight: 750;
      color: rgba(31,45,38,.55);
      font-size: 13px;
    }
    .chev{
      width:10px;height:10px;
      border-right:2px solid rgba(15,61,46,.55);
      border-bottom:2px solid rgba(15,61,46,.55);
      transform: rotate(45deg);
      flex: 0 0 auto;
      margin-top:-2px;
    }

    .date-modal{
      position: fixed;
      inset: 0;
      display:none;
      z-index: 60;
    }
    .date-modal.open{ display:block; }

    .date-backdrop{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(6px);
    }

    .date-card{
      position: relative;
      width: min(720px, calc(100% - 24px));
      margin: 12px auto;
      background: rgba(255,255,255,.96);
      border: 1px solid rgba(201,168,106,.25);
      border-radius: 22px;
      box-shadow: 0 30px 120px rgba(0,0,0,.35);
      max-height: calc(100dvh - 24px);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }

    .date-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 14px 16px;
      border-bottom:1px solid rgba(0,0,0,.06);
      background: linear-gradient(180deg, rgba(201,168,106,.10), rgba(255,255,255,.0));
      flex: 0 0 auto;
    }
    .date-title{
      margin:0;
      font-size: 16px;
      font-weight: 950;
      letter-spacing:.02em;
      color: var(--green);
    }
    .date-x{
      width:40px;height:40px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
      cursor:pointer;
      font-weight: 950;
    }

    .date-body{
      padding: 14px 16px 16px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      flex: 1 1 auto;
    }

    .date-grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }

    .date-btn{
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
      border-radius:16px;
      padding:10px 10px;
      cursor:pointer;
      text-align:left;
      transition:.12s;
      min-height: 56px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:4px;
    }
    .date-btn:hover{ transform: translateY(-1px); box-shadow: 0 10px 22px rgba(0,0,0,.08); }
    .date-btn .d1{
      font-weight: 950;
      color:#1f2d26;
      font-size: 14px;
    }
    .date-btn .d2{
      font-weight: 800;
      color: rgba(31,45,38,.55);
      font-size: 12px;
      letter-spacing:.02em;
    }
    .date-btn.selected{
      border-color: rgba(201,168,106,.85);
      box-shadow: 0 0 0 4px rgba(201,168,106,.18);
    }
    .date-btn.disabled{
      opacity:.45;
      cursor:not-allowed;
      background: rgba(0,0,0,.04);
    }
    .date-btn.disabled .d1,
    .date-btn.disabled .d2{
      color: rgba(0,0,0,.35);
    }

    /* ===== Modal (DIY Info) ===== */
    .modal{
      position: fixed;
      inset: 0;
      display: none;
      z-index: 50;
    }
    .modal.open{ display:block; }

    .modal-backdrop{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(6px);
    }

    .modal-card{
      position: relative;
      width: min(880px, calc(100% - 24px));
      margin: 40px auto;

      background: rgba(255,255,255,.96);
      border: 1px solid rgba(201,168,106,.25);
      border-radius: 22px;
      box-shadow: 0 30px 120px rgba(0,0,0,.35);
      overflow: hidden;

      max-height: calc(100dvh - 24px);
      display: flex;
      flex-direction: column;
    }

    .modal-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      padding: 18px 18px 14px;
      border-bottom: 1px solid rgba(0,0,0,.06);
      background: linear-gradient(180deg, rgba(201,168,106,.10), rgba(255,255,255,.0));
      flex: 0 0 auto;
    }

    .modal-kicker{
      font-size: 11px;
      letter-spacing: .22em;
      text-transform: uppercase;
      color: rgba(15,61,46,.70);
      font-weight: 900;
    }

    .modal-title{
      margin: 6px 0 0;
      font-size: 22px;
      color: #0f3d2e;
      letter-spacing: .02em;
    }

    .modal-x{
      width: 40px;
      height: 40px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.10);
      background: #fff;
      cursor: pointer;
      font-weight: 900;
      flex: 0 0 auto;
    }

    .modal-body{
      padding: 16px 18px 18px;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      flex: 1 1 auto;
    }

    .bilingual-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .bilingual-grid .col{
      background: rgba(15,61,46,.045);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 18px;
      padding: 14px 14px 12px;
    }

    .bilingual-grid h4{
      margin: 0 0 10px;
      font-size: 14px;
      letter-spacing: .06em;
      text-transform: uppercase;
      color: rgba(15,61,46,.85);
    }

    .bilingual-grid ul{
      margin: 0;
      padding-left: 18px;
      color: rgba(22,34,28,.92);
      line-height: 1.55;
      font-size: 14px;
    }

    .bilingual-grid .zh h4{
      letter-spacing: .02em;
      text-transform:none;
    }

    .modal-note{
      margin-top: 14px;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(201,168,106,.35);
      background: rgba(201,168,106,.10);
      color: rgba(120,86,30,.95);
      font-weight: 650;
      font-size: 13px;
      line-height: 1.5;
    }
    .zh-note{
      display:block;
      margin-top: 6px;
      color: rgba(120,86,30,.92);
      font-weight: 650;
    }

    @media(max-width:820px){
      .landing-grid{ grid-template-columns: 1fr; }
      .tile{ min-height: unset; }
    }
    @media(max-width:720px){
      .grid{ grid-template-columns:1fr; }
      .time-grid{ grid-template-columns: repeat(3, 1fr); }
      .flavour-grid{ grid-template-columns: 1fr; }
      .wrap{ margin: 26px auto; }
      .card{ padding: 22px; }
      .brand{ font-size: 26px; }
      .bilingual-grid{ grid-template-columns: 1fr; }
      .modal-card{ margin: 12px auto; }
      .date-grid{ grid-template-columns: repeat(2, 1fr); }
      .date-card{ margin: 12px auto; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">

      <div class="brand">MAGGIE BAKERY</div>
      <div class="location">Albany • Auckland</div>
      <p class="sub" id="pageSub">Choose a booking type below.</p>

      <div class="info">
        <div class="pill has-call">
          <span>Open 10am – 7pm</span>
          <a class="call" href="tel:+64223189478">Call</a>
        </div>

        <div class="pill">
          <a target="_blank" rel="noopener"
             href="https://www.google.com/maps/search/?api=1&query=1%2F200%20Dairy%20Flat%20Highway">
            1/200 Dairy Flat Highway
          </a>
        </div>

        <div class="pill gold">
          <span>Request only · Confirmation required</span>
        </div>
      </div>

      <!-- ============ LANDING ============ -->
      <section id="homeView" class="view active" aria-label="Home">
        <div class="landing-grid">
          <!-- DIY card -->
          <article class="tile">
            <div class="hero" style="background-image:url('images/diy.jpg');background-position: 60% 70%;"></div>
            <div class="tile-body">
              <div class="kicker">ON-SITE ACTIVITY</div>
              <h2 class="tile-title">DIY Cake Workshop</h2>
              <p class="tile-text">
                Join our on-site DIY cake experience. Choose your date and time, and we’ll confirm your spot shortly.
              </p>
              <div class="tile-actions">
                <button class="btn primary" id="goDIY" type="button">Book DIY</button>
                <button class="btn ghost" type="button" id="openDIYInfo">Info</button>
              </div>
            </div>
          </article>

          <!-- Buffet card -->
          <article class="tile">
            <div class="hero" style="background-image:url('images/buffet.jpg');background-position: 70% 80%;"></div>
            <div class="tile-body">
              <div class="kicker">DINING</div>
              <h2 class="tile-title">Buffet</h2>
              <p class="tile-text">
                Our buffet booking will be available soon. Please check back later for updates.
              </p>
              <div class="tile-actions">
                <button class="btn disabled" type="button" disabled>Coming soon</button>
              </div>
            </div>
          </article>
        </div>
      </section>

      <!-- ============ DIY ============ -->
      <section id="diyView" class="view" aria-label="DIY booking">
        <div class="top-actions">
          <button class="back" id="backHome" type="button">← Back</button>
        </div>

        <p class="sub" style="margin-top:6px;">Submit a request and we’ll confirm your booking shortly.</p>

        <form id="form" method="POST" target="hidden_iframe">
          <div class="grid">
            <div>
              <label>Name</label>
              <input name="name" required autocomplete="name" />
            </div>
            <div>
              <label>Phone</label>
              <input name="phone" required autocomplete="tel" />
            </div>
          </div>

          <div class="grid">
            <div>
              <label>Email (optional)</label>
              <input name="email" type="email" autocomplete="email" />
            </div>
            <div>
              <label>Guests</label>
              <select name="guests" id="guests" required>
                <option value="">Select</option>
                <option>1</option><option>2</option><option>3</option><option>4</option>
                <option>5</option><option>6</option><option>7</option><option>8</option>
                <option value="8+">8+</option>
              </select>
            </div>
          </div>

          <!-- Flavours -->
          <div style="margin-top:10px;">
            <label>Flavours (max = guests)</label>
            <div id="flavourGrid" class="flavour-grid"></div>
            <input type="hidden" name="flavours" id="flavours" value="" />
            <div class="flavour-hint" id="flavourHint">Please select guests first.</div>
          </div>

          <div class="grid">
            <div>
              <label>Date</label>

              <!-- Visible trigger -->
              <button type="button" class="date-trigger" id="dateTrigger" aria-haspopup="dialog" aria-controls="dateModal">
                <span id="dateTriggerText">Select a date</span>
                <span class="muted" id="dateRuleText"></span>
                <span class="chev" aria-hidden="true"></span>
              </button>

              <!-- Hidden input for form submit -->
              <input type="hidden" name="date" id="date" required />
            </div>

            <div>
              <label>Time</label>
              <div id="timeGrid" class="time-grid"></div>
              <select name="time" id="time" required hidden>
                <option value="">Select</option>
              </select>
            </div>
          </div>

          <label>Notes</label>
          <textarea name="notes" placeholder="Allergies, birthday message, pram/high chair..."></textarea>

          <button class="submit" id="btn" type="submit">Request a booking</button>

          <div class="toast ok" id="ok">Submitted! We’ll confirm shortly.</div>
          <div class="toast bad" id="bad"></div>
        </form>

        <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>
      </section>

    </div>
  </div>

  <!-- ===== DATE PICKER MODAL ===== -->
  <div class="date-modal" id="dateModal" aria-hidden="true">
    <div class="date-backdrop" data-date-close="1"></div>
    <div class="date-card" role="dialog" aria-modal="true" aria-labelledby="dateModalTitle">
      <div class="date-head">
        <h3 class="date-title" id="dateModalTitle">Select a date</h3>
        <button class="date-x" type="button" aria-label="Close" data-date-close="1">✕</button>
      </div>
      <div class="date-body">
        <div class="date-grid" id="dateGrid"></div>
      </div>
    </div>
  </div>

  <!-- ===== DIY INFO MODAL ===== -->
  <div class="modal" id="diyInfoModal" aria-hidden="true">
    <div class="modal-backdrop" data-close="1"></div>

    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-head">
        <div>
          <div class="modal-kicker">DIY OIL-PAINTING CAKE EXPERIENCE</div>
          <h3 class="modal-title" id="modalTitle">Workshop Details</h3>
        </div>

        <button class="modal-x" type="button" aria-label="Close" data-close="1">✕</button>
      </div>

      <div class="modal-body">
        <div class="bilingual-grid">
          <div class="col">
            <h4>What’s Included</h4>
            <ul>
              <li>1 fresh mini square cream cake</li>
              <li>Cream “painting” materials</li>
              <li>1 drink of your choice</li>
              <li>2-hour creative session</li>
              <li>Light on-site guidance (mostly free creation)</li>
              <li>Enjoy in-store or take away</li>
            </ul>

            <h4 style="margin-top:16px;">Pricing</h4>
            <ul>
              <li><strong>Solo</strong> — $58 (includes 1 drink)</li>
              <li><strong>Two people</strong> — $100 (includes 2 drinks)</li>
              <li><strong>3+ people</strong> — $50 per person</li>
            </ul>
          </div>

          <div class="col zh">
            <h4>内容包含</h4>
            <ul>
              <li>1份新鲜小方形奶油蛋糕</li>
              <li>1份奶油霜绘画材料</li>
              <li>1杯任意口味饮品</li>
              <li>2小时创作体验</li>
              <li>现场简单指导（自由创作为主）</li>
              <li>成品可堂食或带走</li>
            </ul>

            <h4 style="margin-top:16px;">价格</h4>
            <ul>
              <li><strong>单人</strong> — $58（赠送1杯饮品）</li>
              <li><strong>双人</strong> — $100（赠送2杯饮品）</li>
              <li><strong>双人以上</strong> — $50/人</li>
            </ul>
          </div>
        </div>

        <div class="modal-note">
          Tip: If you have allergies or special requests, please add them in Notes when booking.
          <span class="zh-note">小提示：如有过敏或特殊需求，请在预约 Notes 中备注。</span>
        </div>
      </div>
    </div>
  </div>

<script>
  /* =========================
     CONFIG
  ========================== */
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzUcA0p5RGkTLYTLQC6gtcJTWPKhpTxQmkWWP1HLTLn-XYvn9bcxue8Bax8Td3iHj3eGA/exec";

  // booking slots: 10:00–18:00 (10am–6pm)
  const OPEN_HOURS = { start: "10:00", end: "18:00" };
  const SLOT_MINUTES = 30;

  // 3pm rule
  const CUT_OFF_HOUR = 15; // 3pm

  // date list range (show some disabled past dates for grey effect)
  const SHOW_PAST_DAYS = 7;
  const SHOW_FUTURE_DAYS = 45;

  /* =========================
     VIEW ROUTER
  ========================== */
  const homeView = document.getElementById("homeView");
  const diyView = document.getElementById("diyView");
  const pageSub = document.getElementById("pageSub");

  const goDIY = document.getElementById("goDIY");
  const backHome = document.getElementById("backHome");

  function setView(hash){
    const h = (hash || location.hash || "#home").toLowerCase();
    const isDIY = h === "#diy";
    homeView.classList.toggle("active", !isDIY);
    diyView.classList.toggle("active", isDIY);

    pageSub.textContent = isDIY
      ? "Submit a request and we’ll confirm your booking shortly."
      : "Choose a booking type below.";

    if (isDIY) {
      refreshMinDate();
      ensureDateSelected();
      refreshDateUI();
      refreshTimes();
    }
  }

  goDIY.addEventListener("click", () => location.hash = "#diy");
  backHome.addEventListener("click", () => location.hash = "#home");
  window.addEventListener("hashchange", () => setView());
  setView();

  /* =========================
     DIY ELEMENTS
  ========================== */
  const $ = (id) => document.getElementById(id);

  const form = $("form");
  const iframe = $("hidden_iframe");

  // date (custom)
  const dateHidden = $("date");
  const dateTrigger = $("dateTrigger");
  const dateTriggerText = $("dateTriggerText");
  const dateRuleText = $("dateRuleText");
  const dateModal = $("dateModal");
  const dateGrid = $("dateGrid");

  // time
  const timeEl = $("time");
  const timeGrid = $("timeGrid");

  // other
  const btn = $("btn");
  const ok = $("ok");
  const bad = $("bad");
  const guestsEl = $("guests");

  // flavours
  const flavourGrid = $("flavourGrid");
  const flavoursInput = $("flavours");
  const flavourHint = $("flavourHint");

  form.action = SCRIPT_URL;

  /* =========================
     DATE (3pm rule + custom date picker)
  ========================== */
  function localYMD(d = new Date()){
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }
  function addDays(d, n){
    const x = new Date(d);
    x.setDate(x.getDate() + n);
    return x;
  }
  function calcMinDateBy3pmRule(now = new Date()){
    const afterCutoff = (now.getHours() >= CUT_OFF_HOUR);
    const min = addDays(now, afterCutoff ? 2 : 1);
    return localYMD(min);
  }

  let minDate = calcMinDateBy3pmRule();

  function refreshMinDate(){
    minDate = calcMinDateBy3pmRule();
    // show rule text
    const now = new Date();
    const afterCutoff = now.getHours() >= CUT_OFF_HOUR;
    dateRuleText.textContent = afterCutoff ? "After 3pm: from day after tomorrow" : "Before 3pm: from tomorrow";
  }

  function ymdToDate(ymd){
    const [y,m,d] = ymd.split("-").map(Number);
    return new Date(y, m-1, d);
  }

  function formatNice(ymd){
    const d = ymdToDate(ymd);
    // Tue, 12 Mar
    const opt = { weekday:"short", day:"2-digit", month:"short" };
    return d.toLocaleDateString("en-NZ", opt);
  }

  function ensureDateSelected(){
    // if empty or < minDate, set to minDate
    if (!dateHidden.value || dateHidden.value < minDate) {
      dateHidden.value = minDate;
    }
  }

  function openDateModal(){
    dateModal.classList.add("open");
    dateModal.setAttribute("aria-hidden","false");
  }
  function closeDateModal(){
    dateModal.classList.remove("open");
    dateModal.setAttribute("aria-hidden","true");
  }

  function refreshDateUI(){
    // trigger text
    if (dateHidden.value) {
      dateTriggerText.textContent = formatNice(dateHidden.value);
    } else {
      dateTriggerText.textContent = "Select a date";
    }

    // build grid (show some past disabled dates + future dates)
    dateGrid.innerHTML = "";

    const now = new Date();
    const start = addDays(now, -SHOW_PAST_DAYS);
    const end = addDays(now, SHOW_FUTURE_DAYS);

    const selected = dateHidden.value;

    for (let d = new Date(start); d <= end; d = addDays(d, 1)) {
      const ymd = localYMD(d);
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "date-btn";
      btn.dataset.value = ymd;

      const line1 = document.createElement("div");
      line1.className = "d1";
      line1.textContent = d.toLocaleDateString("en-NZ", { weekday:"short" });

      const line2 = document.createElement("div");
      line2.className = "d2";
      line2.textContent = d.toLocaleDateString("en-NZ", { day:"2-digit", month:"short", year:"numeric" });

      btn.appendChild(line1);
      btn.appendChild(line2);

      const disabled = (ymd < minDate);
      if (disabled) {
        btn.classList.add("disabled");
        btn.setAttribute("aria-disabled","true");
      } else {
        btn.addEventListener("click", () => {
          dateHidden.value = ymd;
          refreshDateUI();
          refreshTimes();
          closeDateModal();
        });
      }

      if (ymd === selected) btn.classList.add("selected");

      dateGrid.appendChild(btn);
    }
  }

  dateTrigger.addEventListener("click", () => {
    refreshMinDate();
    ensureDateSelected();
    refreshDateUI();
    openDateModal();
  });

  dateModal.addEventListener("click", (e) => {
    const t = e.target;
    if (t && t.getAttribute && t.getAttribute("data-date-close") === "1") closeDateModal();
  });

  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      if (dateModal.classList.contains("open")) closeDateModal();
    }
  });

  /* =========================
     TIME SLOTS
  ========================== */
  function toMinutes(t){
    const [h,m] = t.split(":").map(Number);
    return h*60 + m;
  }
  function toHHMM(min){
    const h = String(Math.floor(min/60)).padStart(2,"0");
    const m = String(min%60).padStart(2,"0");
    return `${h}:${m}`;
  }
  function buildSlots(){
    const slots = [];
    let s = toMinutes(OPEN_HOURS.start);
    const e = toMinutes(OPEN_HOURS.end);
    while (s <= e){
      slots.push(toHHMM(s));
      s += SLOT_MINUTES;
    }
    return slots;
  }

  function show(el, msg){
    ok.style.display = "none";
    bad.style.display = "none";
    if (msg) el.textContent = msg;
    el.style.display = "block";
  }

  function selectTime(value){
    timeEl.value = value;
    timeGrid.querySelectorAll(".time-btn").forEach(b=>{
      b.classList.toggle("selected", b.dataset.value === value);
    });
  }

  function refreshTimes(){
    const d = dateHidden.value;
    if (!d) return;

    const now = new Date();
    const nowMinutes = now.getHours()*60 + now.getMinutes();
    const today = localYMD(now);

    timeGrid.innerHTML = "";
    timeEl.innerHTML = "";
    const first = document.createElement("option");
    first.value = "";
    first.textContent = "Select";
    timeEl.appendChild(first);

    for (const s of buildSlots()){
      const opt = document.createElement("option");
      opt.value = s;
      opt.textContent = s;
      timeEl.appendChild(opt);

      const b = document.createElement("button");
      b.type = "button";
      b.className = "time-btn";
      b.textContent = s;
      b.dataset.value = s;

      const slotMinutes = toMinutes(s);
      const disable = (d === today) && (slotMinutes < nowMinutes);

      if (disable){
        b.classList.add("disabled");
        b.setAttribute("aria-disabled","true");
      } else {
        b.addEventListener("click", ()=> selectTime(s));
      }

      timeGrid.appendChild(b);
    }

    selectTime("");
  }

  /* =========================
     FLAVOURS (max = guests)
  ========================== */
  const flavours = [
    "Strawberry",
    "Blueberry",
    "Oreo",
    "Chestnut",
    "Taro",
    "Coconut Panna Cotta"
  ];

  const flavourState = Object.fromEntries(flavours.map(f => [f, 0]));

  function guestsMax(){
    const v = guestsEl.value;
    if (!v) return 0;
    if (v === "8+") return 0; // disable flavours
    return Number(v) || 0;
  }

  function totalSelected(){
    return Object.values(flavourState).reduce((a,b)=>a+b,0);
  }

  function syncFlavoursField(){
    const parts = flavours.map(f => `${f}:${flavourState[f]}`);
    flavoursInput.value = parts.join(", ");
  }

  function renderFlavours(){
    flavourGrid.innerHTML = "";

    const max = guestsMax();
    const total = totalSelected();
    const guestNotReady = !guestsEl.value || guestsEl.value === "8+";

    if (!guestsEl.value){
      flavourHint.textContent = "Please select guests first.";
    } else if (guestsEl.value === "8+"){
      flavourHint.textContent = "For 8+ guests, please contact us to confirm. (Flavour selection disabled)";
    } else {
      flavourHint.textContent = `Selected ${total} / ${max}`;
    }

    for (const f of flavours){
      const item = document.createElement("div");
      item.className = "flavour-item";

      const name = document.createElement("div");
      name.className = "flavour-name";
      name.textContent = f;

      const stepper = document.createElement("div");
      stepper.className = "stepper";

      const downBtn = document.createElement("button");
      downBtn.type = "button";
      downBtn.className = "step-btn";
      downBtn.innerHTML = `<span class="tri down"></span>`;

      const qty = document.createElement("div");
      qty.className = "qty";
      qty.textContent = String(flavourState[f]);

      const upBtn = document.createElement("button");
      upBtn.type = "button";
      upBtn.className = "step-btn";
      upBtn.innerHTML = `<span class="tri up"></span>`;

      downBtn.disabled = guestNotReady || flavourState[f] <= 0;
      upBtn.disabled = guestNotReady || total >= max;

      downBtn.addEventListener("click", () => {
        if (guestNotReady) return;
        if (flavourState[f] > 0){
          flavourState[f]--;
          syncFlavoursField();
          renderFlavours();
        }
      });

      upBtn.addEventListener("click", () => {
        if (guestNotReady) return;
        const maxNow = guestsMax();
        const totalNow = totalSelected();
        if (totalNow < maxNow){
          flavourState[f]++;
          syncFlavoursField();
          renderFlavours();
        }
      });

      stepper.appendChild(downBtn);
      stepper.appendChild(qty);
      stepper.appendChild(upBtn);

      item.appendChild(name);
      item.appendChild(stepper);

      flavourGrid.appendChild(item);
    }
  }

  /* =========================
     EVENTS
  ========================== */
  guestsEl.addEventListener("change", () => {
    if (guestsEl.value === "8+") {
      alert("For 8+ guests, please contact us to confirm availability.");
    }
    for (const f of flavours) flavourState[f] = 0;
    syncFlavoursField();
    renderFlavours();
  });

  form.addEventListener("reset", () => {
    for (const f of flavours) flavourState[f] = 0;
    syncFlavoursField();
    renderFlavours();

    refreshMinDate();
    ensureDateSelected();
    refreshDateUI();
    refreshTimes();
    selectTime("");
  });

  /* =========================
     SUBMIT (iframe)
  ========================== */
  let pendingSubmit = false;

  form.addEventListener("submit", (e) => {
    // Must have date + time
    refreshMinDate();
    ensureDateSelected();

    if (!dateHidden.value) {
      e.preventDefault();
      show(bad, "Please select a date.");
      return;
    }

    if (!timeEl.value) {
      e.preventDefault();
      show(bad, "Please select a time.");
      return;
    }

    if (!SCRIPT_URL.includes("script.google.com/macros/s/") || !SCRIPT_URL.endsWith("/exec")) {
      e.preventDefault();
      show(bad, "SCRIPT_URL is not set. Please paste your Apps Script /exec URL.");
      return;
    }

    ok.style.display = "none";
    bad.style.display = "none";
    btn.disabled = true;
    btn.textContent = "Submitting...";
    pendingSubmit = true;

    setTimeout(() => {
      if (!pendingSubmit) return;
      pendingSubmit = false;
      btn.disabled = false;
      btn.textContent = "Request a booking";
      show(bad, "Submitted, but no confirmation returned. Please check your Sheet or Apps Script deployment.");
    }, 12000);
  });

  iframe.addEventListener("load", () => {
    if (!pendingSubmit) return;
    pendingSubmit = false;

    btn.disabled = false;
    btn.textContent = "Request a booking";
    show(ok, "Submitted! We’ll confirm shortly.");

    form.reset();
  });

  /* =========================
     DIY INFO MODAL (mobile scroll fixed)
  ========================== */
  const openDIYInfo = document.getElementById("openDIYInfo");
  const diyInfoModal = document.getElementById("diyInfoModal");

  function isTouchDevice(){
    return window.matchMedia("(pointer: coarse)").matches;
  }

  function openModal(){
    diyInfoModal.classList.add("open");
    diyInfoModal.setAttribute("aria-hidden", "false");
    if (!isTouchDevice()) document.body.style.overflow = "hidden";
  }

  function closeModal(){
    diyInfoModal.classList.remove("open");
    diyInfoModal.setAttribute("aria-hidden", "true");
    document.body.style.overflow = "";
  }

  openDIYInfo?.addEventListener("click", openModal);

  diyInfoModal?.addEventListener("click", (e) => {
    const t = e.target;
    if (t && t.getAttribute && t.getAttribute("data-close") === "1") closeModal();
  });

  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && diyInfoModal.classList.contains("open")) closeModal();
  });

  /* =========================
     INIT
  ========================== */
  syncFlavoursField();
  renderFlavours();

  refreshMinDate();
  ensureDateSelected();
  refreshDateUI();
  refreshTimes();
</script>

</body>
</html>
