<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Maggie Bakery | Reservations</title>

  <style>
    :root{
      --green:#0f3d2e;
      --gold:#c9a86a;
      --gold2:#b89655;
      --muted:#5c6b63;
      --card: rgba(255,255,255,.92);
      --stroke: rgba(201,168,106,.22);
      --shadow: 0 60px 140px rgba(0,0,0,.35);
      --ink:#16221c;

      --cal-bg: rgba(255,255,255,.92);
      --cal-border: rgba(201,168,106,.30);
      --cal-soft: rgba(15,61,46,.06);
      --cal-disabled: rgba(22,34,28,.28);
      --cal-disabled-bg: rgba(0,0,0,.03);
      --cal-hover: rgba(201,168,106,.14);
      --cal-selected: rgba(201,168,106,.22);
      --cal-selected-border: rgba(201,168,106,.75);
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      min-height: 100vh;
      background: linear-gradient(rgba(13,55,40,.76), rgba(13,55,40,.90));
      color: var(--ink);
    }

    body::before{
      content:"";
      position:fixed;
      inset:0;
      background:url("images/restaurant.jpg") center/cover no-repeat;
      filter: blur(5px) brightness(.90);
      transform: scale(1.05);
      z-index:-2;
    }

    .wrap{ max-width: 920px; margin: 56px auto; padding: 0 16px 64px; }

    .card{
      background: var(--card);
      backdrop-filter: blur(18px);
      border-radius: 28px;
      padding: 32px;
      box-shadow: var(--shadow);
      border: 1px solid var(--stroke);
    }

    .brand{
      font-size: 24px;
      letter-spacing: .26em;
      text-transform: uppercase;
      color: var(--gold);
      font-weight: 900;
      text-align:center;
      margin: 6px 0 14px;
    }

    .sub{
      margin:0;
      text-align:center;
      color: var(--muted);
      font-size: 14px;
      line-height:1.5;
    }

    .info{ margin-top: 18px; display:grid; gap:10px; justify-content:center; }

    .pill{
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap: 12px;
      padding: 12px 14px;
      border-radius: 999px;
      background: rgba(15,61,46,.065);
      border: 1px solid rgba(15,61,46,.10);
      color: rgba(15,61,46,.86);
      font-size: 12px;
      font-weight: 700;
      width: min(520px, 100%);
      margin: 0 auto;
    }
    .pill.has-call{ justify-content: space-between; }
    .pill.gold{
      background: rgba(255,255,255,.55);
      border: 1px solid rgba(201,168,106,.55);
      color: rgba(120,86,30,.92);
    }
    .pill a{
      color: rgba(15,61,46,.86);
      text-decoration:none;
      border-bottom: 1px solid rgba(15,61,46,.18);
    }

    .call{
      text-decoration:none;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(201,168,106,.45);
      background: rgba(201,168,106,.16);
      color: rgba(120,86,30,.96);
      font-weight: 900;
      font-size: 12px;
      white-space:nowrap;
    }

    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:14px;
      margin-top: 22px;
    }

    label{
      display:block;
      font-size:13px;
      margin:12px 0 6px;
      color: rgba(15,61,46,.88);
      font-weight: 750;
    }

    input,select,textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(0,0,0,.08);
      background:#fff;
      font-size: 15px;
      outline:none;
    }
    textarea{ min-height: 96px; resize: vertical; }

    .btn{
      margin-top: 18px;
      width:100%;
      border:0;
      border-radius: 18px;
      padding: 15px;
      font-size: 16px;
      font-weight: 900;
      letter-spacing: .10em;
      text-transform: uppercase;
      background: linear-gradient(135deg, var(--gold), var(--gold2));
      color:#fff;
      cursor:pointer;
      transition:.15s;
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    .toast{
      margin-top: 12px;
      padding: 12px;
      border-radius: 14px;
      font-size: 14px;
      display:none;
    }
    .ok{ background:#e7f7ee; color:#1c6f48; }
    .bad{ background:#ffecec; color:#8b1a1a; }

    .time-grid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
      margin-top: 8px;
    }

    .time-btn{
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
      padding:10px;
      border-radius:14px;
      font-size:14px;
      font-weight:800;
      cursor:pointer;
      transition:.12s;
    }
    .time-btn.selected{
      border-color: rgba(201,168,106,.85);
      box-shadow: 0 0 0 4px rgba(201,168,106,.18);
    }
    .time-btn.disabled{ opacity:.45; cursor:not-allowed; }

    /* ===== Custom calendar (Deep green + Gold) ===== */
    .date-box{
      width:100%;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(0,0,0,.08);
      background:#fff;
      font-size: 15px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .date-box .value{
      color: rgba(22,34,28,.92);
      font-weight: 750;
    }
    .date-box .placeholder{
      color: rgba(22,34,28,.45);
      font-weight: 650;
    }
    .date-box .chip{
      font-size: 12px;
      font-weight: 800;
      color: rgba(120,86,30,.95);
      background: rgba(201,168,106,.16);
      border: 1px solid rgba(201,168,106,.35);
      padding: 6px 10px;
      border-radius: 999px;
      white-space: nowrap;
    }

    .calendar{
      margin-top: 10px;
      border-radius: 18px;
      background: var(--cal-bg);
      border: 1px solid var(--cal-border);
      overflow:hidden;
    }

    .cal-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 12px 12px;
      background:
        linear-gradient(180deg, rgba(15,61,46,.10), rgba(15,61,46,.04));
      border-bottom: 1px solid rgba(201,168,106,.25);
    }

    .cal-title{
      font-weight: 900;
      letter-spacing: .06em;
      color: rgba(15,61,46,.92);
      text-transform: uppercase;
      font-size: 12px;
    }

    .cal-nav{
      display:flex;
      gap:8px;
    }

    .cal-nav button{
      border: 1px solid rgba(201,168,106,.35);
      background: rgba(201,168,106,.14);
      color: rgba(120,86,30,.95);
      border-radius: 12px;
      padding: 6px 10px;
      font-weight: 900;
      cursor:pointer;
      font-size: 12px;
    }
    .cal-nav button:disabled{
      opacity:.45;
      cursor:not-allowed;
    }

    .cal-week{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      padding: 10px 12px 8px;
      gap:8px;
      background: rgba(255,255,255,.65);
      border-bottom: 1px solid rgba(0,0,0,.04);
    }
    .cal-week div{
      text-align:center;
      font-size: 11px;
      font-weight: 900;
      color: rgba(15,61,46,.65);
      letter-spacing: .08em;
      text-transform: uppercase;
    }

    .cal-grid{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:8px;
      padding: 12px;
      background: rgba(255,255,255,.75);
    }

    .day{
      height: 42px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.06);
      background: #fff;
      font-weight: 900;
      font-size: 13px;
      color: rgba(22,34,28,.92);
      cursor:pointer;
      transition:.12s;
    }
    .day:hover{
      background: var(--cal-hover);
      border-color: rgba(201,168,106,.35);
      transform: translateY(-1px);
    }
    .day.muted{
      color: rgba(22,34,28,.35);
      background: rgba(0,0,0,.02);
      border-color: rgba(0,0,0,.04);
      cursor: default;
    }
    .day.disabled{
      color: var(--cal-disabled);
      background: var(--cal-disabled-bg);
      border-color: rgba(0,0,0,.05);
      cursor:not-allowed;
    }
    .day.selected{
      background: var(--cal-selected);
      border-color: var(--cal-selected-border);
      box-shadow: 0 0 0 4px rgba(201,168,106,.18);
    }

    .sr-only{
      position:absolute !important;
      width:1px;height:1px;
      padding:0;margin:-1px;
      overflow:hidden;clip:rect(0,0,0,0);
      white-space:nowrap;border:0;
    }

    @media(max-width:720px){
      .grid{ grid-template-columns:1fr; }
      .time-grid{ grid-template-columns: repeat(3, 1fr); }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">

      <div class="brand">MAGGIE BAKERY</div>
      <p class="sub">Submit a request and we’ll confirm your booking shortly.</p>

      <div class="info">
        <div class="pill has-call">
          <span>Open 10am – 7pm</span>
          <a class="call" href="tel:+64223189478">Call</a>
        </div>

        <div class="pill">
          <a target="_blank" rel="noopener"
             href="https://www.google.com/maps/search/?api=1&query=1%2F200%20Dairy%20Flat%20Highway">
            1/200 Dairy Flat Highway
          </a>
        </div>

        <div class="pill gold">
          <span>Request only · Confirmation required</span>
        </div>
      </div>

      <form id="form" method="POST" target="hidden_iframe">
        <div class="grid">
          <div>
            <label>Name</label>
            <input name="name" required autocomplete="name" />
          </div>
          <div>
            <label>Phone</label>
            <input name="phone" required autocomplete="tel" />
          </div>
        </div>

        <div class="grid">
          <div>
            <label>Email (optional)</label>
            <input name="email" type="email" autocomplete="email" />
          </div>
          <div>
            <label>Guests</label>
            <select name="guests" id="guests" required>
              <option value="">Select</option>
              <option>1</option><option>2</option><option>3</option><option>4</option>
              <option>5</option><option>6</option><option>7</option><option>8</option>
              <option value="8+">8+</option>
            </select>
          </div>
        </div>

        <div class="grid">
          <div>
            <label>Date</label>

            <!-- ✅ 自定义日历显示 -->
            <div class="date-box" id="dateBox" role="button" tabindex="0" aria-label="Choose date">
              <div id="dateText" class="placeholder">Select a date</div>
              <div id="dateRuleChip" class="chip"></div>
            </div>

            <div class="calendar" id="calendar" aria-live="polite"></div>

            <!-- ✅ 真正提交用的隐藏 input（保持 name="date" 不变） -->
            <input class="sr-only" name="date" id="date" required aria-hidden="true" />
          </div>

          <div>
            <label>Time</label>
            <div id="timeGrid" class="time-grid"></div>

            <!-- hidden select：给表单提交用 -->
            <select name="time" id="time" required hidden>
              <option value="">Select</option>
            </select>
          </div>
        </div>

        <label>Notes</label>
        <textarea name="notes" placeholder="Allergies, birthday message, pram/high chair..."></textarea>

        <button class="btn" id="btn" type="submit">Request a booking</button>

        <div class="toast ok" id="ok">Submitted! We’ll confirm shortly.</div>
        <div class="toast bad" id="bad"></div>
      </form>

      <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>
    </div>
  </div>

<script>
  // ✅ Apps Script Web App URL（必须以 /exec 结尾）
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzUcA0p5RGkTLYTLQC6gtcJTWPKhpTxQmkWWP1HLTLn-XYvn9bcxue8Bax8Td3iHj3eGA/exec";

  // ✅ 可预约时间：10:00–18:00（10am–6pm）
  const OPEN_HOURS = { start: "10:00", end: "18:00" };
  const SLOT_MINUTES = 30;

  const $ = (id) => document.getElementById(id);
  const form = $("form");
  const iframe = $("hidden_iframe");

  // date
  const dateBox = $("dateBox");
  const dateText = $("dateText");
  const dateRuleChip = $("dateRuleChip");
  const calWrap = $("calendar");
  const dateEl = $("date"); // hidden input

  // time
  const timeEl = $("time");
  const timeGrid = $("timeGrid");

  // ui
  const btn = $("btn");
  const ok = $("ok");
  const bad = $("bad");
  const guestsEl = $("guests");

  form.action = SCRIPT_URL;

  function localYMD(d = new Date()){
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }

  function parseYMD(ymd){
    const [y,m,d] = ymd.split("-").map(Number);
    return new Date(y, m-1, d, 0,0,0,0);
  }

  function formatPretty(ymd){
    const d = parseYMD(ymd);
    const opts = { weekday:"short", year:"numeric", month:"short", day:"numeric" };
    return d.toLocaleDateString("en-NZ", opts);
  }

  // ✅ 3pm 规则：3pm 前最早明天；3pm 后最早后天（含 3:00pm）
  function getEarliestBookableDate(){
    const now = new Date();
    const cutoffMinutes = 15 * 60;
    const nowMinutes = now.getHours() * 60 + now.getMinutes();
    const daysToAdd = (nowMinutes < cutoffMinutes) ? 1 : 2;

    const earliest = new Date(now);
    earliest.setHours(0,0,0,0);
    earliest.setDate(earliest.getDate() + daysToAdd);
    return earliest;
  }

  function getEarliestBookableYMD(){
    return localYMD(getEarliestBookableDate());
  }

  function updateRuleChip(){
    const now = new Date();
    const cutoffMinutes = 15 * 60;
    const nowMinutes = now.getHours() * 60 + now.getMinutes();
    dateRuleChip.textContent = (nowMinutes < cutoffMinutes)
      ? "Before 3pm: earliest is tomorrow"
      : "After 3pm: earliest is the day after tomorrow";
  }

  function show(el, msg){
    ok.style.display = "none";
    bad.style.display = "none";
    if (msg) el.textContent = msg;
    el.style.display = "block";
  }

  function toMinutes(t){
    const [h,m] = t.split(":").map(Number);
    return h*60 + m;
  }

  function toHHMM(min){
    const h = String(Math.floor(min/60)).padStart(2,"0");
    const m = String(min%60).padStart(2,"0");
    return `${h}:${m}`;
  }

  function buildSlots(){
    const slots = [];
    let s = toMinutes(OPEN_HOURS.start);
    const e = toMinutes(OPEN_HOURS.end);
    while (s <= e){
      slots.push(toHHMM(s));
      s += SLOT_MINUTES;
    }
    return slots;
  }

  function selectTime(value){
    timeEl.value = value;
    timeGrid.querySelectorAll(".time-btn").forEach(b=>{
      b.classList.toggle("selected", b.dataset.value === value);
    });
  }

  function refreshTimes(){
    const d = dateEl.value;
    if (!d) return;

    const now = new Date();
    const nowMinutes = now.getHours()*60 + now.getMinutes();
    const today = localYMD(now);

    timeGrid.innerHTML = "";
    timeEl.innerHTML = "";
    const first = document.createElement("option");
    first.value = "";
    first.textContent = "Select";
    timeEl.appendChild(first);

    for (const s of buildSlots()){
      const opt = document.createElement("option");
      opt.value = s;
      opt.textContent = s;
      timeEl.appendChild(opt);

      const b = document.createElement("button");
      b.type = "button";
      b.className = "time-btn";
      b.textContent = s;
      b.dataset.value = s;

      const slotMinutes = toMinutes(s);
      const disable = (d === today) && (slotMinutes < nowMinutes);

      if (disable){
        b.classList.add("disabled");
        b.setAttribute("aria-disabled","true");
      } else {
        b.addEventListener("click", ()=> selectTime(s));
      }

      timeGrid.appendChild(b);
    }

    selectTime("");
  }

  // ===== Calendar rendering =====
  const WEEKDAYS = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
  const MONTHS = ["January","February","March","April","May","June","July","August","September","October","November","December"];

  let viewYear = new Date().getFullYear();
  let viewMonth = new Date().getMonth(); // 0-11

  function startOfMonth(y, m){
    return new Date(y, m, 1, 0,0,0,0);
  }
  function daysInMonth(y, m){
    return new Date(y, m+1, 0).getDate();
  }

  // Monday=0..Sunday=6
  function weekdayMon0(d){
    const js = d.getDay(); // Sun=0..Sat=6
    return (js + 6) % 7;
  }

  function ymdFromParts(y,m,d){
    const mm = String(m+1).padStart(2,"0");
    const dd = String(d).padStart(2,"0");
    return `${y}-${mm}-${dd}`;
  }

  function canSelectDate(ymd){
    const earliest = getEarliestBookableYMD();
    return ymd >= earliest;
  }

  function renderCalendar(){
    updateRuleChip();

    const earliestDate = getEarliestBookableDate();
    const earliestY = earliestDate.getFullYear();
    const earliestM = earliestDate.getMonth();

    // prevent viewing month earlier than earliest month
    if (viewYear < earliestY || (viewYear === earliestY && viewMonth < earliestM)) {
      viewYear = earliestY;
      viewMonth = earliestM;
    }

    const first = startOfMonth(viewYear, viewMonth);
    const leading = weekdayMon0(first);
    const dim = daysInMonth(viewYear, viewMonth);

    const prevMonthDate = new Date(viewYear, viewMonth, 0);
    const prevDim = prevMonthDate.getDate();
    const prevY = prevMonthDate.getFullYear();
    const prevM = prevMonthDate.getMonth();

    const head = document.createElement("div");
    head.className = "cal-head";

    const title = document.createElement("div");
    title.className = "cal-title";
    title.textContent = `${MONTHS[viewMonth]} ${viewYear}`;

    const nav = document.createElement("div");
    nav.className = "cal-nav";

    const btnPrev = document.createElement("button");
    btnPrev.type = "button";
    btnPrev.textContent = "←";
    btnPrev.setAttribute("aria-label", "Previous month");

    const btnNext = document.createElement("button");
    btnNext.type = "button";
    btnNext.textContent = "→";
    btnNext.setAttribute("aria-label", "Next month");

    const prevWouldBeEarlier =
      (viewYear < earliestY) ||
      (viewYear === earliestY && viewMonth <= earliestM);
    btnPrev.disabled = prevWouldBeEarlier;

    btnPrev.addEventListener("click", () => {
      if (btnPrev.disabled) return;
      viewMonth -= 1;
      if (viewMonth < 0){ viewMonth = 11; viewYear -= 1; }
      renderCalendar();
    });

    btnNext.addEventListener("click", () => {
      viewMonth += 1;
      if (viewMonth > 11){ viewMonth = 0; viewYear += 1; }
      renderCalendar();
    });

    nav.appendChild(btnPrev);
    nav.appendChild(btnNext);
    head.appendChild(title);
    head.appendChild(nav);

    const week = document.createElement("div");
    week.className = "cal-week";
    WEEKDAYS.forEach(w=>{
      const el = document.createElement("div");
      el.textContent = w;
      week.appendChild(el);
    });

    const grid = document.createElement("div");
    grid.className = "cal-grid";

    // 42 cells (6 weeks)
    for (let i=0; i<42; i++){
      const cell = document.createElement("button");
      cell.type = "button";
      cell.className = "day";

      let y=viewYear, m=viewMonth, dayNum=0;
      let isCurrent = true;

      if (i < leading){
        // prev month
        isCurrent = false;
        y = prevY; m = prevM;
        dayNum = prevDim - (leading - 1 - i);
        cell.classList.add("muted");
      } else if (i >= leading + dim){
        // next month
        isCurrent = false;
        const next = new Date(viewYear, viewMonth+1, 1);
        y = next.getFullYear(); m = next.getMonth();
        dayNum = (i - (leading + dim)) + 1;
        cell.classList.add("muted");
      } else {
        dayNum = (i - leading) + 1;
      }

      cell.textContent = String(dayNum);

      const ymd = ymdFromParts(y,m,dayNum);

      // only allow selection for current-month visible days? (你也可以允许跨月点，但这里更高级：跨月灰色不可点)
      if (!isCurrent) {
        cell.classList.add("disabled");
        cell.disabled = true;
      } else {
        if (!canSelectDate(ymd)) {
          cell.classList.add("disabled");
          cell.disabled = true;
        } else {
          cell.addEventListener("click", () => {
            dateEl.value = ymd;
            dateText.className = "value";
            dateText.textContent = formatPretty(ymd);

            // highlight selected
            grid.querySelectorAll(".day").forEach(d=>{
              d.classList.toggle("selected", d.dataset?.ymd === ymd);
            });

            refreshTimes();
          });
        }
      }

      cell.dataset.ymd = ymd;

      // selected state
      if (dateEl.value && dateEl.value === ymd) {
        cell.classList.add("selected");
      }

      grid.appendChild(cell);
    }

    calWrap.innerHTML = "";
    calWrap.appendChild(head);
    calWrap.appendChild(week);
    calWrap.appendChild(grid);

    // If current selected date became invalid due to 3pm cutoff, clamp to earliest
    const earliest = getEarliestBookableYMD();
    if (dateEl.value && dateEl.value < earliest) {
      dateEl.value = earliest;
      dateText.className = "value";
      dateText.textContent = formatPretty(earliest);
      refreshTimes();
      // re-render to highlight
      setTimeout(renderCalendar, 0);
    }
  }

  // focus/tap behavior (optional): scroll calendar into view
  dateBox.addEventListener("click", () => {
    calWrap.scrollIntoView({ behavior:"smooth", block:"nearest" });
  });
  dateBox.addEventListener("keydown", (e) => {
    if (e.key === "Enter" || e.key === " ") {
      e.preventDefault();
      calWrap.scrollIntoView({ behavior:"smooth", block:"nearest" });
    }
  });

  guestsEl.addEventListener("change", () => {
    if (guestsEl.value === "8+") {
      alert("For 8+ guests, please contact us to confirm availability.");
    }
  });

  // Submit: iframe
  let pendingSubmit = false;

  form.addEventListener("submit", (e) => {
    if (!dateEl.value) {
      e.preventDefault();
      show(bad, "Please select a date.");
      return;
    }
    if (!timeEl.value) {
      e.preventDefault();
      show(bad, "Please select a time.");
      return;
    }
    if (!SCRIPT_URL.includes("script.google.com/macros/s/") || !SCRIPT_URL.endsWith("/exec")) {
      e.preventDefault();
      show(bad, "SCRIPT_URL is not set. Please paste your Apps Script /exec URL.");
      return;
    }

    ok.style.display = "none";
    bad.style.display = "none";
    btn.disabled = true;
    btn.textContent = "Submitting...";
    pendingSubmit = true;

    setTimeout(() => {
      if (!pendingSubmit) return;
      pendingSubmit = false;
      btn.disabled = false;
      btn.textContent = "Request a booking";
      show(bad, "Submitted, but no confirmation returned. Please check your Sheet or Apps Script deployment.");
    }, 12000);
  });

  iframe.addEventListener("load", () => {
    if (!pendingSubmit) return;
    pendingSubmit = false;

    btn.disabled = false;
    btn.textContent = "Request a booking";
    show(ok, "Submitted! We’ll confirm shortly.");

    form.reset();
    dateEl.value = "";
    dateText.className = "placeholder";
    dateText.textContent = "Select a date";
    timeGrid.innerHTML = "";
    timeEl.innerHTML = '<option value="">Select</option>';
    renderCalendar();
  });

  // Init
  updateRuleChip();
  renderCalendar();
</script>

</body>
</html>
